
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>kivyx.misc.bgmplayer &#8212; kivyx 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for kivyx.misc.bgmplayer</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">*(Tested on CPython3.9.7 + Kivy2.1.0)*</span>

<span class="sd">BGM再生を手助けするmodule</span>

<span class="sd">これが要った理由</span>
<span class="sd">----------------</span>

<span class="sd">このような物が要った理由は :class:`kivy.core.audio.Sound` がそのままでは扱い難かったからです。</span>
<span class="sd">例えば :meth:`kivy.core.audio.Sound.seek` の説明には</span>

<span class="sd">  Most sound providers cannot seek when the audio is stopped. Play then seek.</span>

<span class="sd">とありますが単純に</span>

<span class="sd">.. code-block::</span>

<span class="sd">   sound = SoundLoader.load(...)</span>
<span class="sd">   sound.play()</span>
<span class="sd">   sound.seek(...)</span>

<span class="sd">として良いかというとそうではなく、実際には ``.play()`` の後に少し間を置かないと期待通りに動きませんでした。</span>

<span class="sd">.. code-block::</span>

<span class="sd">   sound = SoundLoader.load(...)</span>
<span class="sd">   sound.play()</span>
<span class="sd">   await async_library.sleep(...)</span>
<span class="sd">   sound.seek(...)</span>

<span class="sd">そしてどうやらこれは ``.seek()`` に限った話ではなく、</span>
<span class="sd">``.play()`` や ``.stop()`` を呼んだ後は少し間を置いてから ``sound`` に触らないと安定しないようです。</span>
<span class="sd">つまり :class:`kivy.core.audio.Sound` を直接触るコードは仕様にすら書かれていないのに必要な *間* でコードが汚されてしまう事になります。</span>

<span class="sd">そこでこのmoduleの出番です。</span>
<span class="sd">このmoduleは *間* を完全に覆い隠すのに加えBGM再生に必要になると思われる次の機能を提供します。</span>

<span class="sd">* 音を鳴らす時には前回停めた位置から再開。</span>
<span class="sd">* 音を停める時には徐々に音量を下げる。</span>
<span class="sd">* 音を鳴らす時には徐々に音量を上げる。</span>

<span class="sd">使い方</span>
<span class="sd">------</span>

<span class="sd">もしアプリが一種類のBGMしか鳴らさないのであれば :class:`Bgm` だけで十分です。</span>

<span class="sd">.. code-block::</span>

<span class="sd">   from kivy.core.audio import SoundLoader</span>
<span class="sd">   from kivyx.misc.bgmplayer import Bgm</span>

<span class="sd">   sound = SoundLoader.load(r&quot;path/to/bgm.ogg&quot;)</span>
<span class="sd">   sound.loop = True</span>
<span class="sd">   bgm = Bgm(sound)</span>
<span class="sd">   </span>
<span class="sd">   # 鳴らしたくなったら</span>
<span class="sd">   bgm.play()</span>

<span class="sd">   # 停めたくなったら</span>
<span class="sd">   bgm.stop()</span>

<span class="sd">そして複数のBGMがある場合は :class:`BgmPlayer` が使えます。</span>

<span class="sd">.. code-block::</span>

<span class="sd">   from kivyx.misc.bgmplayer import BgmPlayer</span>

<span class="sd">   bgmplayer = BgmPlayer()</span>
<span class="sd">   bgmplayer.play(r&quot;path/to/bgm1.ogg&quot;)  # bgm1.oggが鳴る</span>
<span class="sd">   bgmplayer.play(r&quot;path/to/bgm2.ogg&quot;)  # bgm1.oggが停まりbgm2.oggが鳴る</span>
<span class="sd">   bgmplayer.play(r&quot;path/to/bgm1.ogg&quot;)  # bgm2.oggが停まりbgm1.oggが前回停まった位置から鳴る</span>
<span class="sd">   bgmplayer.stop()                     # bgm1.oggが停まる</span>

<span class="sd">:class:`BgmPlayer` は既定では一度読み込んだBGMはずっと持ち続けるので次回以降の再生が早くなります。</span>
<span class="sd">言うまでもなくこれはメモリを惜しみなく使っている事によります。</span>
<span class="sd">もしこの振る舞いを良しとせずメモリの使用量を抑えたいのであれば :class:`MemoryEfficientLoader` が使えます。</span>

<span class="sd">.. code-block::</span>

<span class="sd">   from kivyx.misc.bgmplayer import BgmPlayer, MemoryEfficientLoader</span>

<span class="sd">   bgmplayer = BgmPlayer(loader=MemoryEfficientLoader())</span>

<span class="sd">:class:`MemoryEfficientLoader` はBGMが別の物に切り替えられ次第すぐに以前の物を棄てるのでメモリの使用量が抑えられる...はずです [#hazudearu]_ 。</span>
<span class="sd">反面切り替えられる度に :class:`kivy.core.audio.Sound` を作り直すので二回目以降であってもあまり再生は早くならないです [#os_cache]_ 。</span>

<span class="sd">Loaderの自作</span>
<span class="sd">~~~~~~~~~~~~</span>

<span class="sd">Loaderは自作することもできます。例えば以下のように予めBGMを一括で読み込んでおけば再生開始時の遅延を限りなく抑えられるでしょう。</span>

<span class="sd">.. code-block::</span>

<span class="sd">   loader = {</span>
<span class="sd">       fn: (sound := SoundLoader.load(fn), setattr(sound, &#39;loop&#39;, True), ) and Bgm(sound)</span>
<span class="sd">       for fn in filenames</span>
<span class="sd">   }</span>
<span class="sd">   bgmplayer = BgmPlayer(loader=loader)</span>

<span class="sd">loaderは ``loader[key]`` という式で :class:`Bgm` のinstanceを取り出せるようになっている物なら何でも良く、</span>
<span class="sd">うまく使えば独自のキャッシュ戦略や読み込み戦略を採れるかもしれません。</span>

<span class="sd">.. [#hazudearu] 実際に測ったわけでは無いため</span>
<span class="sd">.. [#os_cache] OSのキャッシュが働けばその分は少しだけ早くなりうる</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Bgm&#39;</span><span class="p">,</span> <span class="s1">&#39;BgmPlayer&#39;</span><span class="p">,</span> <span class="s1">&#39;CachedLoader&#39;</span><span class="p">,</span> <span class="s1">&#39;MemoryEfficientLoader&#39;</span><span class="p">,</span> <span class="p">)</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">kivy.event</span> <span class="kn">import</span> <span class="n">EventDispatcher</span>
<span class="kn">from</span> <span class="nn">kivy.properties</span> <span class="kn">import</span> <span class="n">BoundedNumericProperty</span>
<span class="kn">from</span> <span class="nn">kivy.core.audio</span> <span class="kn">import</span> <span class="n">Sound</span><span class="p">,</span> <span class="n">SoundLoader</span>
<span class="kn">import</span> <span class="nn">asynckivy</span> <span class="k">as</span> <span class="nn">ak</span>


<div class="viewcode-block" id="Bgm"><a class="viewcode-back" href="../../../kivyx-misc-bgmplayer.html#kivyx.misc.bgmplayer.Bgm">[docs]</a><span class="k">class</span> <span class="nc">Bgm</span><span class="p">(</span><span class="n">EventDispatcher</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;一つ分のBGMの再生を司る下層のclass。&#39;&#39;&#39;</span>

    <span class="n">length</span> <span class="o">=</span> <span class="n">BoundedNumericProperty</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    (read-only) BGMの長さ。単位は秒。instance化直後はこの値はNoneなので実際の長さが入れられるまで少し待たないといけない。</span>

<span class="sd">    .. code-block::</span>

<span class="sd">       import asynckivy as ak</span>

<span class="sd">       bgm = Bgm(...)</span>
<span class="sd">       if bgm.length is None:</span>
<span class="sd">           await ak.event(bgm, &#39;length&#39;)</span>
<span class="sd">       print(f&quot;BGMの長さは{bgm.length}秒です&quot;)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">fade_in_duration</span> <span class="o">=</span> <span class="n">BoundedNumericProperty</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;何秒かけて音量を徐々に上げるか&#39;&#39;&#39;</span>

    <span class="n">fade_out_duration</span> <span class="o">=</span> <span class="n">BoundedNumericProperty</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;何秒かけて音量を徐々に下げるか&#39;&#39;&#39;</span>

    <span class="n">volume</span> <span class="o">=</span> <span class="n">BoundedNumericProperty</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;上げきった時の音量&#39;&#39;&#39;</span>

    <span class="n">internal_delay</span> <span class="o">=</span> <span class="n">BoundedNumericProperty</span><span class="p">(</span><span class="mf">.5</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;:class:`kivy.core.audio.Sound` を操作する度に設ける内部用の待ち時間。&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_get_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">get_pos</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_being_played</span> <span class="k">else</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="ow">or</span> <span class="mf">0.</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_pos</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span>
        <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># &#39;length&#39; is not available right now so setting &#39;pos&#39; later</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">new_pos</span>
            <span class="k">return</span>
        <span class="n">sound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sound</span>
        <span class="c1"># normalize</span>
        <span class="n">new_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_pos</span> <span class="o">%</span> <span class="n">length</span><span class="p">)</span> <span class="k">if</span> <span class="n">sound</span><span class="o">.</span><span class="n">loop</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">new_pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">new_pos</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_being_played</span><span class="p">:</span>
            <span class="n">sound</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">new_pos</span><span class="p">)</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_pos</span><span class="p">,</span> <span class="n">_set_pos</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;再生位置。単位は秒。 :meth:`kivy.core.audio.Sound.seek` とは違って停止中にも自由に動かせる。&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sound</span><span class="p">:</span> <span class="n">Sound</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_needs_to_play</span> <span class="o">=</span> <span class="n">ak</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_needs_to_stop</span> <span class="o">=</span> <span class="n">ak</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sound</span> <span class="o">=</span> <span class="n">sound</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_at_max_volume</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_being_played</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="sd">&#39;&#39;&#39;we need an own flag because `Sound.state` is not reliable&#39;&#39;&#39;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_main_task</span> <span class="o">=</span> <span class="n">ak</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_main</span><span class="p">())</span>
        
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">asynckivy</span> <span class="kn">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">animate</span>
        <span class="n">sound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sound</span>
        <span class="n">needs_to_play</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_needs_to_play</span>
        <span class="n">needs_to_stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_needs_to_stop</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_get_sound_length</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_delay</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="ow">or</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">sound</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="k">await</span> <span class="n">needs_to_play</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="n">sound</span><span class="o">.</span><span class="n">play</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">internal_delay</span><span class="p">)</span>
                <span class="n">sound</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_pos</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_being_played</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">await</span> <span class="n">animate</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fade_in_duration</span><span class="p">)</span>
                <span class="n">sound</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_at_max_volume</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">await</span> <span class="n">needs_to_stop</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_at_max_volume</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">await</span> <span class="n">animate</span><span class="p">(</span><span class="n">sound</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fade_out_duration</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">sound</span><span class="o">.</span><span class="n">get_pos</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_being_played</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">sound</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">internal_delay</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sound</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">volume</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_at_max_volume</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sound</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">volume</span>

<div class="viewcode-block" id="Bgm.play"><a class="viewcode-back" href="../../../kivyx-misc-bgmplayer.html#kivyx.misc.bgmplayer.Bgm.play">[docs]</a>    <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">reset_pos</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;BGMを鳴らす。既定では前回の停止位置から再開するが ``reset_pos`` が真だと常に最初から鳴る。&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_pos</span> <span class="o">=</span> <span class="n">reset_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_needs_to_stop</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_needs_to_play</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>

<div class="viewcode-block" id="Bgm.stop"><a class="viewcode-back" href="../../../kivyx-misc-bgmplayer.html#kivyx.misc.bgmplayer.Bgm.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;BGMを停める&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_needs_to_play</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_needs_to_stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>

<div class="viewcode-block" id="Bgm.unload"><a class="viewcode-back" href="../../../kivyx-misc-bgmplayer.html#kivyx.misc.bgmplayer.Bgm.unload">[docs]</a>    <span class="k">def</span> <span class="nf">unload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; :meth:`kivy.core.audio.Sound.unload` を呼んで資源を解放する。以後はこのオブジェクトを操作しても何も起こらない。&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_main_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span></div></div>


<span class="k">async</span> <span class="k">def</span> <span class="nf">_get_sound_length</span><span class="p">(</span><span class="n">sound</span><span class="p">:</span> <span class="n">Sound</span><span class="p">,</span> <span class="n">internal_delay</span><span class="p">):</span>
    <span class="n">sound</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">sound</span><span class="o">.</span><span class="n">play</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">ak</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">internal_delay</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">sound</span><span class="o">.</span><span class="n">length</span>
    <span class="n">sound</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">ak</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">internal_delay</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">length</span>


<div class="viewcode-block" id="BgmPlayer"><a class="viewcode-back" href="../../../kivyx-misc-bgmplayer.html#kivyx.misc.bgmplayer.BgmPlayer">[docs]</a><span class="k">class</span> <span class="nc">BgmPlayer</span><span class="p">(</span><span class="n">EventDispatcher</span><span class="p">):</span>
    <span class="n">fade_in_duration</span> <span class="o">=</span> <span class="n">BoundedNumericProperty</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;何秒かけて音量を徐々に上げるか&#39;&#39;&#39;</span>

    <span class="n">fade_out_duration</span> <span class="o">=</span> <span class="n">BoundedNumericProperty</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;何秒かけて音量を徐々に下げるか&#39;&#39;&#39;</span>

    <span class="n">volume</span> <span class="o">=</span> <span class="n">BoundedNumericProperty</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;上げきった時の音量&#39;&#39;&#39;</span>

    <span class="n">internal_delay</span> <span class="o">=</span> <span class="n">BoundedNumericProperty</span><span class="p">(</span><span class="mf">.5</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39; :attr:`Bgm.internal_delay` &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">loader</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_needs_to_switch</span> <span class="o">=</span> <span class="n">ak</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cur_bgm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">loader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loader</span> <span class="o">=</span> <span class="n">CachedLoader</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_main_task</span> <span class="o">=</span> <span class="n">ak</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_main</span><span class="p">(</span><span class="n">loader</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loader</span><span class="p">):</span>
        <span class="n">needs_to_switch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_needs_to_switch</span>

        <span class="n">cur_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cur_bgm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">needs_to_switch</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">needs_to_switch</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">next_key</span><span class="p">,</span> <span class="n">reset_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_op</span>
            <span class="n">has_key_changed</span> <span class="o">=</span> <span class="n">next_key</span> <span class="o">!=</span> <span class="n">cur_key</span>
            <span class="n">needs_to_stop</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cur_bgm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">has_key_changed</span>
            <span class="n">needs_to_load</span> <span class="o">=</span> <span class="n">has_key_changed</span> <span class="ow">and</span> <span class="p">(</span><span class="n">next_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">needs_to_stop</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur_bgm</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">cur_bgm</span><span class="o">.</span><span class="n">fade_out_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fade_out_duration</span>
                <span class="n">cur_bgm</span><span class="o">.</span><span class="n">internal_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_delay</span>
                <span class="n">cur_bgm</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">ak</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">cur_bgm</span><span class="o">.</span><span class="n">fade_out_duration</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_delay</span><span class="p">)</span>
                <span class="n">cur_bgm</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">cur_key</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">needs_to_load</span><span class="p">:</span>
                <span class="n">cur_bgm</span> <span class="o">=</span> <span class="n">loader</span><span class="p">[</span><span class="n">next_key</span><span class="p">]</span>
                <span class="n">cur_bgm</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
                <span class="n">cur_key</span> <span class="o">=</span> <span class="n">next_key</span>
                <span class="n">cur_bgm</span><span class="o">.</span><span class="n">fade_in_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fade_in_duration</span>
                <span class="n">cur_bgm</span><span class="o">.</span><span class="n">internal_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_delay</span>
                <span class="n">cur_bgm</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">reset_pos</span><span class="o">=</span><span class="n">reset_pos</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">ak</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">cur_bgm</span><span class="o">.</span><span class="n">fade_in_duration</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_delay</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cur_bgm</span> <span class="o">=</span> <span class="n">cur_bgm</span>
                <span class="n">cur_bgm</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>

    <span class="k">def</span> <span class="nf">on_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">volume</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cur_bgm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cur_bgm</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">volume</span>

<div class="viewcode-block" id="BgmPlayer.play"><a class="viewcode-back" href="../../../kivyx-misc-bgmplayer.html#kivyx.misc.bgmplayer.BgmPlayer.play">[docs]</a>    <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">reset_pos</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;BGMを鳴らす。既定では前回の停止位置から再開するが ``reset_pos`` が真だと常に最初から鳴る。&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_op</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">reset_pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_needs_to_switch</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>

<div class="viewcode-block" id="BgmPlayer.stop"><a class="viewcode-back" href="../../../kivyx-misc-bgmplayer.html#kivyx.misc.bgmplayer.BgmPlayer.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;BGMを停める&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_op</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_needs_to_switch</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div></div>



<div class="viewcode-block" id="CachedLoader"><a class="viewcode-back" href="../../../kivyx-misc-bgmplayer.html#kivyx.misc.bgmplayer.CachedLoader">[docs]</a><span class="k">class</span> <span class="nc">CachedLoader</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;一度読み込んだBGMをずっと保持し続けるLoader&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">sound</span> <span class="o">=</span> <span class="n">SoundLoader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">sound</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">bgm</span> <span class="o">=</span> <span class="n">Bgm</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">bgm</span>
        <span class="k">return</span> <span class="n">bgm</span></div>


<div class="viewcode-block" id="MemoryEfficientLoader"><a class="viewcode-back" href="../../../kivyx-misc-bgmplayer.html#kivyx.misc.bgmplayer.MemoryEfficientLoader">[docs]</a><span class="k">class</span> <span class="nc">MemoryEfficientLoader</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;BGM読み込み時に以前のBGMを破棄してメモリ使用量を抑えるLoader&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_bgm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_filename</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_bgm</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">last_bgm</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_bgm</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_bgm</span><span class="o">.</span><span class="n">pos</span>
            <span class="n">last_bgm</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
        <span class="n">sound</span> <span class="o">=</span> <span class="n">SoundLoader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">sound</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">bgm</span> <span class="o">=</span> <span class="n">Bgm</span><span class="p">(</span><span class="n">sound</span><span class="p">)</span>
        <span class="n">bgm</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos_dict</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_bgm</span> <span class="o">=</span> <span class="n">bgm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">return</span> <span class="n">bgm</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">kivyx</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../kivyx-misc-bgmplayer.html">背景音楽</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kivyx-uix-analogclock.html">アナログ時計</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kivyx-uix-aspectratio.html">縦横比の固定</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kivyx-uix-behaviors-fontsizeadjustment.html">文字サイズの自動調節</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kivyx-uix-behaviors-spinner.html">Spinnerの自作</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kivyx-uix-behaviors-tablikelooks.html">TabbedPanelに飽きた人へ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kivyx-uix-boxlayout.html">柔軟なBoxLayout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kivyx-uix-drawer.html">引き出し</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kivyx-uix-magnet.html">Magnet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kivyx-utils.html">utils</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Nattōsai Mitō.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>